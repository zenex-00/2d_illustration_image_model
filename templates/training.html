{% extends "layout.html" %}

{% block title %}Training - Gemini 3 Pro{% endblock %}

{% block content %}
<h2>LoRA Training</h2>

<form method="post" action="/ui/training" enctype="multipart/form-data" id="training-form">
    <div class="form-group">
        <label>Input Images (Photos)</label>
        <input type="file" 
               name="input_files" 
               multiple 
               accept="image/*" 
               required
               aria-label="Upload input images for training"
               aria-describedby="input-help">
        <small id="input-help">Upload multiple input images (vehicle photos). Minimum 10 pairs required.</small>
    </div>
    
    <div class="form-group">
        <label>Target Images (Vector Style)</label>
        <input type="file" 
               name="target_files" 
               multiple 
               accept="image/*" 
               required
               aria-label="Upload target images for training"
               aria-describedby="target-help">
        <small id="target-help">Upload corresponding target images (desired vector output). Must match input count.</small>
    </div>
    
    <h3>Training Parameters</h3>
    
    <div class="grid">
        <div class="form-group">
            <label>Learning Rate</label>
            <input type="number" name="learning_rate" value="0.0001" step="0.00001" min="0.00001" max="0.01" required>
        </div>
        
        <div class="form-group">
            <label>Batch Size</label>
            <input type="number" name="batch_size" value="1" min="1" max="8" required>
        </div>
        
        <div class="form-group">
            <label>Number of Epochs</label>
            <input type="number" name="num_epochs" value="10" min="1" max="100" required>
        </div>
        
        <div class="form-group">
            <label>LoRA Rank</label>
            <input type="number" name="rank" value="32" min="4" max="128" required>
        </div>
        
        <div class="form-group">
            <label>LoRA Alpha</label>
            <input type="number" name="alpha" value="16" min="1" max="256" required>
        </div>
        
        <div class="form-group">
            <label>Validation Split</label>
            <input type="number" name="validation_split" value="0.2" step="0.05" min="0.1" max="0.5" required>
        </div>
        
        <div class="form-group">
            <label>Random Seed</label>
            <input type="number" name="seed" value="42" min="0" max="2147483647" required>
        </div>
    </div>
    
    <button type="submit" 
            id="submit-btn"
            aria-label="Start LoRA training job">Start Training</button>
</form>

{% if recent_jobs %}
<h3>Recent Training Jobs</h3>
<div class="card">
    <ul>
        {% for job in recent_jobs %}
        <li>
            <a href="/ui/training/jobs/{{ job.job_id }}">
                Job {{ job.job_id[:8] }} - 
                <span class="status-badge status-{{ job.status }}">{{ job.status }}</span>
                - {{ job.created_at }}
            </a>
        </li>
        {% endfor %}
    </ul>
</div>
{% endif %}

{% if trained_models %}
<h3>Available Trained Models</h3>
<div class="card">
    <ul>
        {% for model in trained_models %}
        <li>{{ model.name }} (Job: {{ model.job_id[:8] }})</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<script>
document.getElementById('training-form').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('submit-btn');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Starting Training...';
    
    // Re-enable button if form submission fails (timeout fallback)
    const form = this;
    setTimeout(function() {
        // If still disabled after 5 seconds and form hasn't submitted, re-enable
        if (submitBtn.disabled && !form.dataset.submitted) {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            alert('Form submission timed out. Please try again.');
        }
    }, 5000);
    
    // Mark form as submitted on successful navigation
    form.addEventListener('submit', function() {
        form.dataset.submitted = 'true';
    }, { once: true });
});
</script>
{% endblock %}



