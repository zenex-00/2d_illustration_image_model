{% extends "layout.html" %}

{% block title %}Training Job {{ job.job_id[:8] }} - Gemini 3 Pro{% endblock %}

{% block extra_head %}
<style>
.phase-indicators {
    display: flex;
    gap: 1rem;
    margin: 1rem 0;
    flex-wrap: wrap;
}
.phase {
    flex: 1;
    min-width: 200px;
    padding: 0.75rem;
    border-radius: 4px;
    border: 2px solid #ddd;
    background: #f5f5f5;
}
.phase.pending {
    opacity: 0.5;
}
.phase.active {
    border-color: #4CAF50;
    background: #e8f5e9;
}
.phase.complete {
    border-color: #2196F3;
    background: #e3f2fd;
}
.phase-progress {
    display: block;
    margin-top: 0.5rem;
    font-size: 0.9em;
    color: #666;
}
.image-gallery {
    margin-top: 2rem;
}
.gallery-tabs {
    display: flex;
    gap: 0.5rem;
    border-bottom: 2px solid #ddd;
    margin-bottom: 1rem;
}
.gallery-tab {
    padding: 0.5rem 1rem;
    cursor: pointer;
    border: none;
    background: transparent;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
}
.gallery-tab.active {
    border-bottom-color: #2196F3;
    color: #2196F3;
    font-weight: bold;
}
.gallery-content {
    display: none;
}
.gallery-content.active {
    display: block;
}
.image-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
}
.image-thumbnail {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 4px;
    cursor: pointer;
    border: 2px solid #ddd;
}
.image-thumbnail:hover {
    border-color: #2196F3;
}
.log-container {
    max-height: 400px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 0.9em;
    background: #f5f5f5;
    padding: 1rem;
    border-radius: 4px;
}
.log-line {
    margin: 0.25rem 0;
    word-wrap: break-word;
}
.current-operation {
    padding: 0.75rem;
    background: #e3f2fd;
    border-left: 4px solid #2196F3;
    margin: 1rem 0;
    font-weight: 500;
}
</style>
{% endblock %}

{% block content %}
<h2>Training Job: {{ job.job_id[:8] }}</h2>

<div id="job-status-container" 
     {% if job.status != 'completed' and job.status != 'failed' %}
     hx-get="/ui/training/jobs/{{ job.job_id }}/status" 
     hx-trigger="every 3s"
     hx-swap="innerHTML"
     hx-indicator="#loading-spinner"
     hx-on::htmx:response-error="console.error('Status update failed'); this.setAttribute('hx-trigger', 'none');"
     {% endif %}>
    <div id="loading-spinner" class="htmx-indicator loading-spinner"></div>
    <div id="job-status">
        <span class="status-badge status-{{ job.status }}">{{ job.status }}</span>
        <span>Progress: {{ job.progress|default(0) }}%</span>
        {% if job.current_epoch|default(0) > 0 %}
        <span>Epoch: {{ job.current_epoch }}/{{ job.total_epochs }}</span>
        {% endif %}
        {% if job.train_loss %}
        <span>Train Loss: {{ "%.4f"|format(job.train_loss) }}</span>
        {% endif %}
        {% if job.val_loss %}
        <span>Val Loss: {{ "%.4f"|format(job.val_loss) }}</span>
        {% endif %}
    </div>
    
    <div class="phase-indicators">
        <div class="phase phase-{{ 'active' if job.phase_status.get('phase1_status') == 'processing' else 'complete' if job.phase_status.get('phase1_status') == 'completed' else 'pending' }}">
            <span>Phase 1: Semantic Sanitization</span>
            <span class="phase-progress">{{ job.phase_status.get('phase1_progress', '0/0') }}</span>
        </div>
        <div class="phase phase-{{ 'active' if job.phase_status.get('phase2_status') == 'processing' else 'complete' if job.phase_status.get('phase2_status') == 'completed' else 'pending' }}">
            <span>Phase 2: Preprocessing</span>
            <span class="phase-progress">{{ job.phase_status.get('phase2_progress', '0/0') }}</span>
        </div>
        <div class="phase phase-{{ 'active' if job.status == 'processing' and job.phase_status.get('phase2_status') == 'completed' else 'complete' if job.status == 'completed' else 'pending' }}">
            <span>Training: LoRA Training</span>
        </div>
    </div>
    
    {% if job.logs and job.logs|length > 0 %}
    {% set last_log = job.logs[-1] %}
    {% if 'Phase' in last_log or 'Removing background' in last_log or 'Generating depth' in last_log or 'Detecting edges' in last_log %}
    <div class="current-operation">
        {{ last_log|e }}
    </div>
    {% endif %}
    {% endif %}
    
    <div class="log-container">
        {% for log in job.logs|default([]) %}
        <div class="log-line">{{ log|e }}</div>
        {% endfor %}
    </div>
</div>

{% if job.status == 'completed' %}
<div class="alert alert-success">
    <h3>Training Completed!</h3>
    {% if job.artifacts and job.artifacts.weights %}
    <p>Weights saved to: <code>{{ job.artifacts.weights|e }}</code></p>
    {% endif %}
</div>
{% elif job.status == 'failed' %}
<div class="alert alert-error">
    <h3>Training Failed</h3>
    {% if job.error %}
    <p>Error: {{ job.error|e }}</p>
    {% endif %}
</div>
{% endif %}

<div class="card">
    <h3>Training Parameters</h3>
    {% if job.metadata %}
    <ul>
        <li>Learning Rate: {{ job.metadata.get('learning_rate', 'N/A') }}</li>
        <li>Batch Size: {{ job.metadata.get('batch_size', 'N/A') }}</li>
        <li>Epochs: {{ job.metadata.get('num_epochs', 'N/A') }}</li>
        <li>LoRA Rank: {{ job.metadata.get('rank', 'N/A') }}</li>
        <li>LoRA Alpha: {{ job.metadata.get('alpha', 'N/A') }}</li>
        <li>Validation Split: {{ job.metadata.get('validation_split', 'N/A') }}</li>
        <li>Seed: {{ job.metadata.get('seed', 'N/A') }}</li>
    </ul>
    {% else %}
    <p>No training parameters available</p>
    {% endif %}
</div>

{% if job.metadata and job.metadata.get('intermediate_images_dir') %}
<div class="card image-gallery">
    <h3>Preprocessed Images</h3>
    <div class="gallery-tabs">
        <button class="gallery-tab active" onclick="showGalleryTab('raw')">Raw Inputs</button>
        <button class="gallery-tab" onclick="showGalleryTab('phase1')">Phase 1 Outputs</button>
        <button class="gallery-tab" onclick="showGalleryTab('phase2_depth')">Depth Maps</button>
        <button class="gallery-tab" onclick="showGalleryTab('phase2_edge')">Edge Maps</button>
        <button class="gallery-tab" onclick="showGalleryTab('targets')">Targets</button>
    </div>
    <div id="gallery-raw" class="gallery-content active">
        <div class="image-grid" id="gallery-raw-grid">
            <p>Loading images...</p>
        </div>
    </div>
    <div id="gallery-phase1" class="gallery-content">
        <div class="image-grid" id="gallery-phase1-grid">
            <p>Loading images...</p>
        </div>
    </div>
    <div id="gallery-phase2_depth" class="gallery-content">
        <div class="image-grid" id="gallery-phase2_depth-grid">
            <p>Loading images...</p>
        </div>
    </div>
    <div id="gallery-phase2_edge" class="gallery-content">
        <div class="image-grid" id="gallery-phase2_edge-grid">
            <p>Loading images...</p>
        </div>
    </div>
    <div id="gallery-targets" class="gallery-content">
        <div class="image-grid" id="gallery-targets-grid">
            <p>Loading images...</p>
        </div>
    </div>
</div>

<script>
function showGalleryTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.gallery-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.gallery-tab').forEach(el => el.classList.remove('active'));
    
    // Show selected tab
    document.getElementById('gallery-' + tabName).classList.add('active');
    event.target.classList.add('active');
    
    // Load images if not already loaded
    loadGalleryImages(tabName);
}

function loadGalleryImages(type) {
    const gridId = 'gallery-' + type + '-grid';
    const grid = document.getElementById(gridId);
    
    // Check if already loaded
    if (grid.dataset.loaded === 'true') {
        return;
    }
    
    fetch(`/api/training/jobs/{{ job.job_id }}/preprocessing-gallery`)
        .then(response => response.json())
        .then(data => {
            const imageList = data[type.replace('phase2_', 'phase2_').replace('_', '_')] || [];
            const keyMap = {
                'raw': 'raw_inputs',
                'phase1': 'phase1_outputs',
                'phase2_depth': 'phase2_depth',
                'phase2_edge': 'phase2_edge',
                'targets': 'targets'
            };
            const images = data[keyMap[type]] || [];
            
            if (images.length === 0) {
                grid.innerHTML = '<p>No images available yet.</p>';
                return;
            }
            
            grid.innerHTML = images.map(img => 
                `<img src="${img.url}" alt="${img.name}" class="image-thumbnail" onclick="window.open('${img.url}', '_blank')">`
            ).join('');
            grid.dataset.loaded = 'true';
        })
        .catch(error => {
            console.error('Error loading gallery:', error);
            grid.innerHTML = '<p>Error loading images.</p>';
        });
}

// Load initial tab on page load
document.addEventListener('DOMContentLoaded', function() {
    loadGalleryImages('raw');
});
</script>
{% endif %}

<a href="/ui/training">
    <button>Back to Training</button>
</a>
{% endblock %}

