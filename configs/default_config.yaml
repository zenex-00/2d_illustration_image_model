pipeline:
  version: "3.0.0"
  name: "Gemini 3 Pro Vehicle-to-Vector"
  random_seed: 42

hardware:
  device: "cuda"
  precision: "float16"  # Required for RTX 4090 (24GB VRAM) - reduces memory by ~50%
  max_vram_gb: 24  # RTX 4090 VRAM limit
  enable_xformers: true  # Enabled for RTX 4090 - provides memory-efficient attention
  enable_attention_slicing: true  # Required for RTX 4090 - reduces memory by ~30%

serverless:
  model_volume_path: "/models"
  enable_load_run_flush: true
  cold_start_timeout: 10
  max_execution_time: 300

phase1:
  enabled: true
  grounding_dino:
    model_id: "IDEA-Research/grounding-dino-base"
    box_threshold: 0.35
    text_threshold: 0.25
    prompts:
      - "side view mirror"
      - "car logo"
      - "brand badge"
      - "license plate"
      - "text"
      - "sticker"
  sam:
    model: "vit_h"
    checkpoint: "sam_vit_h_4b8939.pth"
    dilation_kernel: 5
  lama:
    model: "big-lama"
  quality_threshold: 0.97  # IoU threshold for validation

phase2:
  enabled: true
  iou_retry:
    max_retries: 2
    iou_threshold: 0.85
    allow_skip_on_failure: false  # If true, continue with best attempt when all retries fail
  sdxl:
    base_model: "stabilityai/stable-diffusion-xl-base-1.0"
    num_inference_steps: 30
    guidance_scale: 7.5
    scheduler: "UniPCMultistepScheduler"
    negative_prompt: "blurry, distorted, anatomically incorrect, text, watermark, logo"
  controlnet:
    depth_model: "diffusers/controlnet-depth-sdxl-1.0"
    canny_model: "diffusers/controlnet-canny-sdxl-1.0"
    depth_weight: 0.6
    canny_weight: 0.4
    canny_step_off: 0.75
  lora:
    path: "vector_style_v1.safetensors"
    scale: 0.8
  background_removal:
    enabled: true
    model: "birefnet"
  depth_estimation:
    enabled: true
    model: "zoedepth"
  edge_detection:
    enabled: true

training:
  phase1_retry:
    max_retries: 3
    retry_on_no_change: true  # Retry if output is identical to input
    skip_on_failure: false  # If true, skip images that fail after all retries; if false, use original image
    parameter_variations:
      - box_threshold: 0.25
        text_threshold: 0.15  # More sensitive
      - box_threshold: 0.35
        text_threshold: 0.25  # Default
      - box_threshold: 0.45
        text_threshold: 0.35  # Less sensitive
      - box_threshold: 0.55
        text_threshold: 0.45  # Very conservative
    fallback_models:
      - sam_model: "vit_l"  # Try lighter SAM
      - sam_model: "vit_b"  # Try even lighter

  phase2_retry:
    max_retries: 3
    parameter_variations:
      - bg_model: "birefnet"
        depth_model: "zoedepth"
      - bg_model: "u2net"
        depth_model: "zoedepth-nk"
      - bg_model: "silueta"
        depth_model: "zoedepth"
    skip_on_failure: false  # Exclude failed images instead of using placeholders

phase3:
  enabled: true
  upscaler:
    enabled: true
    model: "RealESRGAN_x4plus_anime"
    scale: 4
  quantization:
    enabled: true
    method: "auto"  # "exact", "approximate", or "auto" (exact if available, else approximate)
    palette_colors: 15
  noise_removal:
    enabled: true
    min_area_percent: 0.001  # 0.1% of image area

phase4:
  enabled: true
  centerline:
    enabled: true
  vtracer:
    mode: "stacked"
    filter_speckle: 4
    corner_threshold: 60
    segment_length: 4
    timeout_seconds: 300
  svg:
    stroke_width: 2
    stroke_color: "black"
    strategy: "A"  # or "B" for centerlines

output:
  formats: ["svg", "png"]
  svg_resolution: 4096
  png_preview_resolution: 2048

